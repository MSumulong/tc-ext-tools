
############################################################################
#                                                                          #
#    package build functions: configure, compile, install, rules, etc.     #
#                                                                          #
############################################################################

# fix for lzo1x.h not found error
export CFLAGS="$CFLAGS -I/usr/local/include/lzo"
export CXXFLAGS="$CXXFLAGS -I/usr/local/include/lzo"

unset LDFLAGS; export LDFLAGS="-Wl,--hash-style=gnu"

## configure
build_configure() {

   # fix for finding full path to libraries
   sudo busybox cp -Lf /usr/local/bin/gcc /usr/local/bin/gcc
   sudo busybox cp -Lf /usr/local/bin/ld /usr/local/bin/ld

   rm -f configure
   ./bootstrap || return 1
   ./configure --prefix=/usr/local --docdir=/usr/local/share/doc/xbmc \
       --disable-debug --enable-external-libraries --disable-external-python \
       --enable-faac --disable-ccache --enable-goom --enable-gl --enable-webserver --enable-xrandr \
       --disable-gles --enable-vdpau --disable-external-ffmpeg \
       --enable-joystick --enable-pulse --enable-rtmp --enable-ffmpeg-libvorbis --disable-mid \
       --disable-hal --disable-avahi --disable-asap-codec --enable-external-libass \
       --disable-libdts --disable-liba52 || return 1

}

## compile
build_compile() {

   make || return 1
   make -C lib/addons/script.module.pil || return 1
   make -C lib/addons/script.module.pysqlite || return 1

}

## install
build_install() {

   make DESTDIR="$I_ROOT" install || return 1

   # Replace FEH.py with FEH.sh (and thus remove external python dependency)
   install -D -m 0755 "${PACKAGE_SRC}/FEH.sh" "${I_ROOT}/usr/local/share/xbmc/FEH.sh" || return 1
   sed -i -e 's/^python \(.*\)FEH.py \(.*\)$/\1FEH.sh \2/' "${I_ROOT}/usr/local/bin/xbmc" || return 1

   # lsb_release fix
   install -D -m 0755 "${PACKAGE_SRC}/lsb_release.sh" "${I_ROOT}/usr/local/bin/lsb_release" || return 1

   # .desktop files
   install -D -m 0644 tools/Linux/xbmc.desktop "${I_ROOT}/usr/local/share/applications/xbmc.desktop" || return 1
   install -D -m 0644 tools/Linux/xbmc-48x48.png "${I_ROOT}/usr/local/share/pixmaps/xbmc.png" || return 1

   # Tools
   install -D -m 0755 xbmc-xrandr "${I_ROOT}/usr/local/share/xbmc/xbmc-xrandr" || return 1
   install -D -m 0755 tools/TexturePacker/TexturePacker "${I_ROOT}/usr/local/share/xbmc/" || return 1

   # clean up unneccessary files
   rm -rf "${I_ROOT}/usr/local/share/xsessions"
   rm -f "${I_ROOT}/usr/local/share/xbmc/FEH.py"
   rm -f "${I_ROOT}/usr/local/share/icons/hicolor/icon-theme.cache"
}

## rules
build_rules() {

   tet_load
   tet_download
   tet_convert
   tet_unpack
   tet_patch
   tet_configure
   tet_compile
   tet_install
   tet_split
   tet_strip
   tet_create
   tet_generate
   tet_check
   tet_package

}

