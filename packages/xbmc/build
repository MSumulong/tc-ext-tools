
############################################################################
#                                                                          #
#    package build functions: configure, compile, install, rules, etc.     #
#                                                                          #
############################################################################

# make sure mysql_config is in path
export PATH="$PATH:/usr/local/mysql/bin"

fix_mysql_include() {

  if [ -f /usr/local/tce.installed/mysql-dev -a ! -f "/usr/local/mysql/include/mysql/mysql.h" ]
  then
     cd /usr/local/mysql/include/
     sudo mv mysql mysql2
     sudo mkdir mysql
     sudo mv * mysql
     sudo mv mysql/mysql2 mysql/mysql
     cd -
  fi

}

## configure
build_configure() {

   fix_mysql_include

   bash bootstrap

   bash configure --prefix=/usr/local \
    --disable-static \
    --disable-debug \
    --enable-optimizations \
    --enable-external-libraries \
    --enable-gl \
    --enable-sdl \
    --enable-vaapi \
    --enable-vdpau \
    --enable-joystick \
    --enable-xrandr \
    --enable-rsxs \
    --enable-projectm \
    --enable-x11 \
    --enable-pulse \
    --enable-rtmp \
    --enable-ffmpeg-libvorbis \
    --enable-webserver \
    --enable-optical-drive \
    --enable-libbluray \
    --enable-texturepacker \
    --enable-hal \
    --enable-udev \
    --enable-nfs \
    --disable-dvdcss \
    --disable-non-free \
    --disable-libcec \
    --disable-afpclient \
    --disable-airplay \
    --disable-airtunes \
    --disable-samba \
    --disable-avahi \
    --disable-vdadecoder \
    --disable-vtbdecoder \
    --disable-openmax \
    --disable-tegra \
    --disable-profiling \
    --disable-external-ffmpeg

}

## compile
build_compile() {

   make || return 1

}

## install
build_install() {

   make DESTDIR="$I_ROOT" install || return 1

   # lsb_release fix
   install -D -m 0755 "${PACKAGE_SRC}/lsb_release.sh" "${I_ROOT}/usr/local/bin/lsb_release" || return 1

   # Tools
   install -D -m 0755 xbmc-xrandr "${I_ROOT}/usr/local/share/xbmc/xbmc-xrandr" || return 1
   install -D -m 0755 tools/TexturePacker/TexturePacker "${I_ROOT}/usr/local/share/xbmc/" || return 1

   # clean up unneccessary files
   rm -f "${I_ROOT}/usr/local/share/icons/hicolor/icon-theme.cache"
}

## rules
build_rules() {

   tet_load
   tet_download
   tet_convert
   tet_unpack
   tet_patch
   tet_configure
   tet_compile
   tet_install
   tet_split
   tet_strip
   tet_create
   tet_generate
   tet_check
   tet_test
   tet_package
   tet_encrypt

}

