#
# tc-ext-tools build functions: configure, compile, install, rules
#

export CFLAGS="$CFLAGS -mmmx -msse"

### Configure
build_configure() {

  build/gyp_chromium -f make build/all.gyp --depth=. \
    -Ddisable_sse2=1 \
    -Dno_strict_aliasing=1 \
    -Dwerror= \
    -Dlinux_sandbox_path=/usr/local/chromium-browser/chromium-browser-sandbox \
    -Dlinux_use_gold_binary=0 \
    -Dlinux_use_gold_flags=0 \
    -Dlinux_strip_binary=1 \
    -Dffmpeg_branding=Chrome \
    -Dproprietary_codecs=1 \
    -Drelease_extra_cflags="${CFLAGS}" \
    -Dremoting=0 \
    -Duse_cups=0 \
    -Duse_system_libjpeg=0 \
    -Duse_system_libxslt=0 \
    -Duse_system_libxml=0 \
    -Duse_system_bzip2=0 \
    -Duse_system_zlib=0 \
    -Duse_system_libpng=0 \
    -Duse_system_libevent=0 \
    -Duse_system_ssl=0 \
    -Duse_system_ffmpeg=0 \
    -Duse_system_yasm=0 \
    -Ddisable_nacl=1 \
    -Ddisable_pnacl=1 \
    -Duse_gconf=0 \
    -Ddisable_glibc=1 || return 1

  # Missing gyp files in tarball (http://crbug.com/144823)
  sed -i '/nacl_test_data\.gyp/d' chrome/chrome_tests.gypi

}
##

### Compile
build_compile() {

  [ -e /usr/bin/gcc ] || sudo ln -s /usr/local/bin/gcc /usr/bin/gcc

  make chrome chrome_sandbox BUILDTYPE=Release || return 1

}
##

### Install
build_install() {

  install -m 755 -D out/Release/chrome "$INSTALL_ROOT/usr/local/chromium-browser/chromium-browser" || return 1
  install -m 4755 out/Release/chrome_sandbox "$INSTALL_ROOT/usr/local/chromium-browser/chromium-browser-sandbox" || return 1
  install -m 644 -D out/Release/*.pak "$INSTALL_ROOT/usr/local/chromium-browser" || return 1
  install -m 755 -D out/Release/libffmpegsumo.so ${INSTALL_ROOT}/usr/local/chromium-browser/libffmpegsumo.so || return 1
  install -m 755 -D out/Release/xdg-settings ${INSTALL_ROOT}/usr/local/chromium-browser/xdg-settings || return 1
  install -m 644 -D out/Release/chrome.1 ${INSTALL_ROOT}/usr/local/share/man/man1/chromium-browser.1 || return 1
  cp -a out/Release/resources ${INSTALL_ROOT}/usr/local/chromium-browser || return 1

  # building fails with nacl enabled
  #install -m 755 -D out/Release/libppGoogleNaClPluginChrome.so ${INSTALL_ROOT}/usr/local/chromium-browser/ || return 1
  #cp out/Release/nacl_irt_x86_*.nexe ${INSTALL_ROOT}/usr/local/chromium-browser/ || return 1
  #cp out/Release/nacl_helper* ${INSTALL_ROOT}/usr/local/chromium-browser/ || return 1

  install -m 644 -D ${PACKAGE_SRC}/chromium-browser.desktop ${INSTALL_ROOT}/usr/local/share/applications/chromium-browser.desktop || return 1
  install -m 755 -D ${PACKAGE_SRC}/chromium-browser.sh ${INSTALL_ROOT}/usr/local/bin/chromium-browser || return 1
  install -m 644 -D LICENSE ${INSTALL_ROOT}/usr/local/share/doc/chromium-browser/LICENSE || return 1
  install -m 644 -D AUTHORS ${INSTALL_ROOT}/usr/local/share/doc/chromium-browser/AUTHORS || return 1
  install -m 755 -d ${INSTALL_ROOT}/usr/local/chromium-browser-addons || return 1
  cp -a out/Release/locales ${INSTALL_ROOT}/usr/local/chromium-browser-addons || return 1
  ln -s /usr/local/chromium-browser-addons/plugins ${INSTALL_ROOT}/usr/local/chromium-browser/plugins || return 1
  ln -s /usr/local/chromium-browser-addons/locales ${INSTALL_ROOT}/usr/local/chromium-browser/locales || return 1

  for size in 22 24 48 64 128 256; do
    sudo install -m 644 -D chrome/app/theme/chromium/product_logo_${size}.png ${INSTALL_ROOT}/usr/local/share/icons/hicolor/${size}x${size}/apps/chromium-browser.png || return 1
  done

  for size in 16 32; do
    sudo install -m 644 -D chrome/app/theme/default_100_percent/chromium/product_logo_${size}.png ${INSTALL_ROOT}/usr/local/share/icons/hicolor/${size}x${size}/apps/chromium-browser.png || return 1
  done

}
##

### Rules
build_rules() {

  tet_load
  tet_download
  tet_convert
  tet_unpack
  tet_patch
  tet_configure
  tet_compile
  tet_install
  tet_split
  tet_strip
  tet_create
  tet_generate
  tet_check
  tet_test
  tet_package
  tet_encrypt

}
##
