#
# tc-ext-tools build functions: configure, compile, install, rules
#

# Configure
build_configure() {

  cp "$PACKAGE_SRC/LocalConfig.kmk" .

  ./configure --disable-pulse --disable-java --disable-docs \
       --enable-vnc || return 1

}

# Compile
build_compile() {

  source ./env.sh

  kmk all || return 1

  cd out/linux.x86/release/bin/src
  make || return 1

  cd ../additions/src
  make || return 1

  cd vboxvideo
  make || return 1

}

# Install
build_install() {

  source ./env.sh

  mkdir -p "$INSTALL_ROOT/usr/local/bin"
  mkdir -p "$INSTALL_ROOT/usr/local/sbin"
  mkdir -p "$INSTALL_ROOT/usr/local/lib/virtualbox/components"
  mkdir -p "$INSTALL_ROOT/usr/local/share/virtualbox/nls"
  mkdir -p "$INSTALL_ROOT/usr/local/share/doc/virtualbox-ose"

  # virtualbox-ose
  install -m 0644 COPYING "$INSTALL_ROOT/usr/local/share/doc/virtualbox-ose/license" || return 1

  cd out/linux.x86/release/bin
  install -m 0755 VBox.sh "$INSTALL_ROOT/usr/local/bin/VBox" || return 1

  ln -sf VBox "$INSTALL_ROOT/usr/local/bin/VBoxHeadless" || return 1
  ln -sf VBox "$INSTALL_ROOT/usr/local/bin/VBoxManage" || return 1
  ln -sf VBox "$INSTALL_ROOT/usr/local/bin/VBoxSDL" || return 1
  ln -sf VBox "$INSTALL_ROOT/usr/local/bin/VirtualBox" || return 1
  ln -sf VBox "$INSTALL_ROOT/usr/local/bin/VBoxVRDP" || return 1
  ln -sf VBox "$INSTALL_ROOT/usr/local/bin/VBoxBalloonCtrl" || return 1

  install -m 0755 VBoxTunctl "$INSTALL_ROOT/usr/local/bin" || return 1

  install -m 0755 components/* "$INSTALL_ROOT/usr/local/lib/virtualbox/components" || return 1

  install -m 0755 *.so "$INSTALL_ROOT/usr/local/lib/virtualbox" || return 1
  install -m 0644 *.gc *.r0 VBoxEFI*.fd "$INSTALL_ROOT/usr/local/lib/virtualbox" || return 1

  install -m 4755 VBoxHeadless VBoxSDL VBoxNetDHCP VBoxNetAdpCtl VirtualBox VBoxBFE \
     "$INSTALL_ROOT/usr/local/lib/virtualbox" || return 1

  install -m 0755 VBoxManage VBoxSVC VBoxXPCOMIPCD VBoxExtPackHelperApp VBoxBalloonCtrl \
      VBoxSysInfo.sh vboxshell.py VBoxCreateUSBNode.sh xpidl VBoxTestOGL EfiThunk \
     "$INSTALL_ROOT/usr/local/lib/virtualbox" || return 1

  install -m 0755 SUPInstall SUPLoggerCtl SUPUninstall "$INSTALL_ROOT/usr/local/lib/virtualbox" || return 1

  install -m 0755 nls/*.qm "$INSTALL_ROOT/usr/local/share/virtualbox/nls" || return 1

  # install icons, desktop and mime info
  for i in 16x16 20x20 24x24 32x32 48x48 64x64 72x72 96x96 128x128 256x256
  do
      install -Dm644 "icons/$i/virtualbox-ova.png" "$INSTALL_ROOT/usr/local/share/icons/hicolor/$i/mimetypes/virtualbox-ova.png"
      install -Dm644 "icons/$i/virtualbox-ovf.png" "$INSTALL_ROOT/usr/local/share/icons/hicolor/$i/mimetypes/virtualbox-ovf.png"
      install -Dm644 "icons/$i/virtualbox-vbox.png" "$INSTALL_ROOT/usr/local/share/icons/hicolor/$i/mimetypes/virtualbox-vbox.png"
      install -Dm644 "icons/$i/virtualbox-vbox-extpack.png" "$INSTALL_ROOT/usr/local/share/icons/hicolor/$i/mimetypes/virtualbox-vbox-extpack.png"
      install -Dm644 "icons/$i/virtualbox-hdd.png" "$INSTALL_ROOT/usr/local/share/icons/hicolor/$i/mimetypes/virtualbox-hdd.png"
      install -Dm644 "icons/$i/virtualbox-vdi.png" "$INSTALL_ROOT/usr/local/share/icons/hicolor/$i/mimetypes/virtualbox-vdi.png"
      install -Dm644 "icons/$i/virtualbox-vhd.png" "$INSTALL_ROOT/usr/local/share/icons/hicolor/$i/mimetypes/virtualbox-vhd.png"
      install -Dm644 "icons/$i/virtualbox-vmdk.png" "$INSTALL_ROOT/usr/local/share/icons/hicolor/$i/mimetypes/virtualbox-vmdk.png"
  done
  install -D -m 0644 VBox.png "$INSTALL_ROOT/usr/local/share/pixmaps/virtualbox.png" || return 1
  install -D -m 0644 virtualbox.xml "$INSTALL_ROOT/usr/local/share/mime/packages/virtualbox.xml" || return 1
  install -D -m 0644 virtualbox.desktop "$INSTALL_ROOT/usr/local/share/applications/virtualbox-ose.desktop" || return 1

  mkdir -p "$INSTALL_ROOT/usr/local/etc/vbox"
  echo "INSTALL_DIR=/usr/local/lib/virtualbox" > "$INSTALL_ROOT/usr/local/etc/vbox/vbox.cfg"

  install -D -m 0644 "$PACKAGE_SRC/60-virtualbox.rules" "$INSTALL_ROOT/lib/udev/rules.d/60-virtualbox.rules" || return 1

  install -D -m 0744 "$PACKAGE_SRC/vboxdrv.sh" "$INSTALL_ROOT/usr/local/etc/init.d/vboxdrv" || return 1

  # virtualbox-ose kernel modules
  cd "$PACKAGE_SOURCE_TOPDIR/out/linux.x86/release/bin/src"

  install -d -m755 "$INSTALL_ROOT/usr/local/lib/modules/$KERNEL/kernel/misc" || return 1
  install -m 0644 *.ko "$INSTALL_ROOT/usr/local/lib/modules/$KERNEL/kernel/misc" || return 1

  # virtualbox-ose guest additions
  cd "$PACKAGE_SOURCE_TOPDIR/out/linux.x86/release/bin/additions"

  install -m755 VBoxClient VBoxControl VBoxService "$INSTALL_ROOT/usr/local/bin" || return 1
  install -m4755 mount.vboxsf "$INSTALL_ROOT/usr/local/sbin" || return 1

  install -d -m755 "$INSTALL_ROOT/usr/local/etc/xdg/autostart"
  install -m755 "$PACKAGE_SOURCE_TOPDIR/src/VBox/Additions/x11/Installer/98vboxadd-xclient" "$INSTALL_ROOT/usr/local/bin/VBoxClient-all" || return 1
  install -m644 "$PACKAGE_SOURCE_TOPDIR/src/VBox/Additions/x11/Installer/vboxclient.desktop" "$INSTALL_ROOT/usr/local/etc/xdg/autostart/vboxclient.desktop" || return 1

  install -D -m644 "$PACKAGE_SRC/xorg.conf.sample" "$INSTALL_ROOT/usr/local/share/virtualbox-ose-additions/xorg.conf.sample" || return 1

  install -Dm755 vboxmouse_drv_111.so "$INSTALL_ROOT/usr/local/lib/X11/modules/input/vboxmouse.so" || return 1
  install -Dm755 vboxvideo_drv_111.so "$INSTALL_ROOT/usr/local/lib/X11/modules/drivers/vboxvideo.so" || return 1

  install -m755 VBoxOGL*.so "$INSTALL_ROOT/usr/local/lib" || return 1
  install -d -m755 "$INSTALL_ROOT/usr/local/lib/X11/modules/dri"
  ln -s /usr/local/lib/VBoxOGL.so "$INSTALL_ROOT/usr/local/lib/X11/modules/dri/vboxvideo_dri.so" || return 1

  # virtualbox-ose guest additions kernel modules
  cd "$PACKAGE_SOURCE_TOPDIR/out/linux.x86/release/bin/additions/src"

  cd vboxguest
  install -D -m644 vboxguest.ko "$INSTALL_ROOT/usr/local/lib/modules/$KERNEL/kernel/misc/vboxguest.ko" || return 1

  cd ../vboxsf
  install -D -m644 vboxsf.ko "$INSTALL_ROOT/usr/local/lib/modules/$KERNEL/kernel/misc/vboxsf.ko" || return 1

  cd ../vboxvideo
  install -D -m644 vboxvideo.ko "$INSTALL_ROOT/usr/local/lib/modules/$KERNEL/kernel/misc/vboxvideo.ko" || return 1

  install -D -m 0644 "$PACKAGE_SRC/60-vboxguest.rules" "$INSTALL_ROOT/lib/udev/rules.d/60-vboxguest.rules" || return 1

  # compress kernel modules with gzip
  gzip "$INSTALL_ROOT"/usr/local/lib/modules/"$KERNEL"/kernel/misc/*.ko || return 1

}

# Rules
build_rules() {

   tet_load
   tet_prepare
   tet_download
   tet_convert
   tet_unpack
   tet_patch
   tet_configure
   tet_compile
   tet_install
   tet_split
   tet_strip
   tet_create
   tet_generate
   tet_check
   tet_package

}

