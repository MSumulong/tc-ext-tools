
############################################################################
#                                                                          #
#  tc-ext-tools build functions: configure, compile, install, rules, etc.  #
#                                                                          #
############################################################################

# temporary fix for fetching sources error, every update git tag id must be updated too !!!
# check related tag for id: http://cgit.freedesktop.org/libreoffice/bootstrap/
export GIT_TAG_ID="b4bcd413f91091ddba30d63473a287a5e7424aa3"

############################################################################ 
#                            Configure                                     #
############################################################################

build_configure() {

  sudo ln -sf /usr/local/lib/pkgconfig/mozilla-plugin.pc /usr/local/lib/pkgconfig/xulrunner-plugin.pc

  aclocal || return 1
  autoconf --force || return 1

  ./configure --prefix=/usr/local --with-distro=TinyCoreLinux \
              --with-binsuffix="" --with-build-version="$VERSION for Tiny Core Linux by Arslan S." \
              --with-docdir=/usr/local/share/doc/libreoffice --mandir=/usr/local/share/man \
              --disable-odk --enable-extensions --enable-graphite --enable-evolution2 \
              --enable-cairo --enable-kde4 --disable-pam --enable-crashdump \
              --enable-ldap --enable-lockdown --enable-pdfimport --enable-presenter-console \
              --enable-presenter-extra-ui --enable-report-builder --enable-wiki-publisher \
              --disable-gio --disable-mono --disable-kde \
              --with-gcc-speedup=ccache --without-java --with-lang="" \
              --with-openclipart=/usr/local/share/openclipart --with-system-unixodbc-headers \
              --with-languagetool --with-oooblogger --with-nlpsolver \
              --with-google-docs --with-watch-window --with-ct2n \
              --with-sun-templates --with-installed-ooo-dirname=libreoffice \
              --disable-post-install-scripts \
              --with-num-cpus=2 --with-max-jobs=3 --with-drink=coffee || return 1

}

############################################################################ 
#                               Custom                                     #
############################################################################

build_custom() {

  cd $PACKAGE_SOURCE_TOPDIR

  if [ -d "$TCEXTTOOLS_SRC"/download-src ]; then
       busybox cp -rf "$TCEXTTOOLS_SRC"/download-src/* ./
      ./download || return 1
  else
       ./download || return 1
       mkdir -p "$TCEXTTOOLS_SRC"/download-src/src

       for TYPE in gz tgz bz2 zip jar oxt txt html dll
       do
              busybox cp -f src/*.${TYPE} "$TCEXTTOOLS_SRC/download-src/src"
       done

       busybox cp -rf clone "$TCEXTTOOLS_SRC"/download-src
  fi

}

############################################################################ 
#                              Compile                                     #
############################################################################

build_compile() {

  [ -e /usr/bin/python ] || sudo ln -sf /usr/local/bin/python /usr/bin/python

  make || return 1

}

############################################################################ 
#                              Install                                     #
############################################################################

build_install() {

  ./bin/ooinstall "$INSTALL_ROOT/usr/local/libreoffice" || return 1

  ln -snf /usr/local/libreoffice/basis3.2 "$INSTALL_ROOT/usr/local/libreoffice/basis-link" || return 1
  ln -snf /usr/local/libreoffice/ure "$INSTALL_ROOT/usr/local/libreoffice/basis3.2/ure-link" || return 1

  install -m 755 -d "$INSTALL_ROOT/usr/local/bin"
  for WRAPPER in oobase  oocalc  oodraw  ooffice  ooimpress  oomath  ooweb  oowriter unopkg
  do
      install -m 755 "$PACKAGE_SRC/$WRAPPER" "$INSTALL_ROOT/usr/local/bin/$WRAPPER" || return 1
  done

  ln -s /usr/local/bin/ooffice "$INSTALL_ROOT/usr/local/bin/libreoffice"

  install -m 755 -d "$INSTALL_ROOT/usr/local/share/applications"
  install -m 644 desktop/*.desktop "$INSTALL_ROOT/usr/local/share/applications" || return 1
  mv -f "$INSTALL_ROOT/usr/local/share/applications/startcenter.desktop" "$INSTALL_ROOT/usr/local/share/applications/libreoffice.desktop"
  rm -f "$INSTALL_ROOT/usr/local/share/applications/template.desktop"

  for DIR in 16x16 22x22 24x24 32x32 48x48
  do
      install -m 755 -d "$INSTALL_ROOT/usr/local/share/icons/hicolor/$DIR/apps"
      install -m 755 -d "$INSTALL_ROOT/usr/local/share/icons/hicolor/$DIR/mimetypes"
      install -m 644 desktop/$DIR/*.png "$INSTALL_ROOT/usr/local/share/icons/hicolor/$DIR/apps" || return 1
      install -m 644 desktop/mimetypes/$DIR/*.png "$INSTALL_ROOT/usr/local/share/icons/hicolor/$DIR/mimetypes" || return 1
  done

  install -m 755 -d "$INSTALL_ROOT"/usr/local/share/icons/hicolor/scalable/apps
  install -m 644 desktop/scalable/*.svg "$INSTALL_ROOT"/usr/local/share/icons/hicolor/scalable/apps || return 1

}

############################################################################ 
#                                Rules                                     #
############################################################################

build_rules() {

   buildit load || exit 1
   buildit download || exit 1
   buildit convert || exit 1
   buildit unpack || exit 1
   buildit patch || exit 1
   buildit configure || exit 1
   buildit custom || exit 1
   buildit compile || exit 1
   buildit install || exit 1
   buildit split || exit 1
   buildit strip || exit 1
   buildit create || exit 1
   buildit generate || exit 1
   buildit check || exit 1
   buildit package || exit 1
   buildit compress || exit 1

}

