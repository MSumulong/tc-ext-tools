#
# tc-ext-tools build functions: configure, compile, install, rules
#

build_convert() {

   sh "$PACKAGE_SOURCE" --extract "$SOURCE_TOPDIR" || return 1

   tar -cJvf "$SOURCE_NAME_CONVERTED" "$SOURCE_TOPDIR" || return 1

   busybox mv -f "$SOURCE_NAME_CONVERTED" "$TCEXTTOOLS_SRC" || return 1

}

build_unpack() {

   sh "$PACKAGE_SOURCE" --extract "$SOURCE_TOPDIR" || return 1

}

# Configure
build_configure() {

   return 0

}

# Compile
build_compile() {

   return 0

}

# Install
build_install() {

   ## Install userspace tools and libraries
   # Create directories
   install -m755 -d "${INSTALL_ROOT}/etc/ati"
   install -m755 -d "${INSTALL_ROOT}/usr/local/etc/init.d"
   install -m755 -d "${INSTALL_ROOT}/etc/profile.d"
   install -m755 -d "${INSTALL_ROOT}/etc/acpi/events"
   install -m755 -d "${INSTALL_ROOT}/etc/security/console.apps"

   install -m755 -d "${INSTALL_ROOT}/usr/local/lib/X11/modules/dri"
   install -m755 -d "${INSTALL_ROOT}/usr/local/lib/X11/modules/drivers"
   install -m755 -d "${INSTALL_ROOT}/usr/local/lib/X11/modules/extensions"
   install -m755 -d "${INSTALL_ROOT}/usr/local/lib/X11/modules/linux"
   install -m755 -d "${INSTALL_ROOT}/usr/local/lib/dri"

   install -m755 -d "${INSTALL_ROOT}/usr/local/src"

   install -m755 -d "${INSTALL_ROOT}/usr/local/bin"
   install -m755 -d "${INSTALL_ROOT}/usr/local/sbin"

   install -m755 -d "${INSTALL_ROOT}/usr/local/include/X11/extensions"
   install -m755 -d "${INSTALL_ROOT}/usr/local/include/GL"

   install -m755 -d "${INSTALL_ROOT}/usr/local/share/applications"
   install -m755 -d "${INSTALL_ROOT}/usr/local/share/ati/amdcccle"
   install -m755 -d "${INSTALL_ROOT}/usr/local/share/doc/ati-fglrx"
   install -m755 -d "${INSTALL_ROOT}/usr/local/share/doc/ati-fglrx-kernel-source"
   install -m755 -d "${INSTALL_ROOT}/usr/local/share/man/man8"
   install -m755 -d "${INSTALL_ROOT}/usr/local/share/pixmaps"

   # X.org driver
   cd "${PACKAGE_SOURCE_TOPDIR}/x750/usr/X11R6/lib/modules" || return 1

   #install -m644 *.a "${INSTALL_ROOT}/usr/local/lib/X11/modules/" || return 1
   install -m755 *.so "${INSTALL_ROOT}/usr/local/lib/X11/modules/" || return 1
   install -m755 drivers/*.so "${INSTALL_ROOT}/usr/local/lib/X11/modules/drivers/" || return 1
   install -m755 linux/*.so "${INSTALL_ROOT}/usr/local/lib/X11/modules/linux/" || return 1
   install -m755 extensions/libglx.so "${INSTALL_ROOT}/usr/local/lib/X11/modules/extensions/" || return 1
   #install -m755 extensions/libdri.so "${INSTALL_ROOT}/usr/local/lib/X11/modules/extensions/libdri.ati" || return 1

   cd "${PACKAGE_SOURCE_TOPDIR}/arch/x86/usr" || return 1

   install -m755 X11R6/bin/* "${INSTALL_ROOT}/usr/local/bin/" || return 1
   install -m755 sbin/* "${INSTALL_ROOT}/usr/local/sbin/" || return 1
   install -m755 X11R6/lib/*.so* "${INSTALL_ROOT}/usr/local/lib/" || return 1
   install -m644 X11R6/lib/*.a "${INSTALL_ROOT}/usr/local/lib/" || return 1 # really needed?
   install -m644 X11R6/lib/*.cap "${INSTALL_ROOT}/usr/local/lib/" || return 1
   install -m755 X11R6/lib/modules/dri/*.so "${INSTALL_ROOT}/usr/local/lib/X11/modules/dri/" || return 1
   install -m755 lib/*.so* "${INSTALL_ROOT}/usr/local/lib/" || return 1

   ln -sf /usr/local/lib/X11/modules/dri/fglrx_dri.so ${INSTALL_ROOT}/usr/local/lib/dri/fglrx_dri.so
   ln -sf libfglrx_dm.so.1.0 "${INSTALL_ROOT}/usr/local/lib/libfglrx_dm.so.1"
   ln -sf libfglrx_dm.so.1.0 "${INSTALL_ROOT}/usr/local/lib/libfglrx_dm.so"
   #ln -sf libfglrx_pp.so.1.0 "${INSTALL_ROOT}/usr/local/lib/libfglrx_pp.so.1"
   #ln -sf libfglrx_tvout.so.1.0 "${INSTALL_ROOT}/usr/local/lib/libfglrx_tvout.so.1"
   ln -sf libfglrx_gamma.so.1.0 "${INSTALL_ROOT}/usr/local/lib/libfglrx_gamma.so.1"
   ln -sf libGL.so.1.2 "${INSTALL_ROOT}/usr/local/lib/libGL.so.1"
   ln -sf libGL.so.1.2 "${INSTALL_ROOT}/usr/local/lib/libGL.so"
   ln -sf libatiuki.so.1.0 "${INSTALL_ROOT}/usr/local/lib/libatiuki.so.1"
   ln -sf libatiuki.so.1.0 "${INSTALL_ROOT}/usr/local/lib/libatiuki.so"

   cd "${PACKAGE_SOURCE_TOPDIR}/common"

   install -m644 etc/ati/* "${INSTALL_ROOT}/etc/ati/" || return 1
   chmod 755 "${INSTALL_ROOT}/etc/ati/authatieventsd.sh" || return 1

   #security provided with 10.9, is it working fine?
   install -m644 etc/security/console.apps/amdcccle-su "${INSTALL_ROOT}/etc/security/console.apps/" || return 1

   install -m644 usr/X11R6/include/X11/extensions/*.h "${INSTALL_ROOT}/usr/local/include/X11/extensions/" || return 1
   install -m644 usr/X11R6/bin/amdupdaterandrconfig "${INSTALL_ROOT}/usr/local/bin/" || return 1
   install -m644 usr/include/GL/*.h "${INSTALL_ROOT}/usr/local/include/GL/" || return 1
   install -m755 usr/sbin/*.sh "${INSTALL_ROOT}/usr/local/sbin/" || return 1
   install -m644 usr/share/ati/amdcccle/* "${INSTALL_ROOT}/usr/local/share/ati/amdcccle/" || return 1 # ? what are these files for?
   install -m644 usr/share/applications/amdcccle.desktop "${INSTALL_ROOT}/usr/local/share/applications/ati-catalyst.desktop" || return 1
   install -m644 usr/share/icons/*.xpm "${INSTALL_ROOT}/usr/local/share/pixmaps/" || return 1
   install -m644 usr/share/man/man8/*.8 "${INSTALL_ROOT}/usr/local/share/man/man8/" || return 1

   # ACPI example files
   install -m755 usr/share/doc/fglrx/examples/etc/acpi/*.sh "${INSTALL_ROOT}/etc/acpi/" || return 1
   sed -i -e 's/usr\/X11R6/usr\/local/g' "${INSTALL_ROOT}/etc/acpi/ati-powermode.sh" || return 1
   install -m644 usr/share/doc/fglrx/examples/etc/acpi/events/* "${INSTALL_ROOT}/etc/acpi/events/" || return 1

   # Add ATI Events Daemon launcher
   install -m755 "${PACKAGE_SRC}/atieventsd.sh" "${INSTALL_ROOT}/usr/local/etc/init.d/atieventsd" || return 1

   # thanks to cerebral, we dont need that damned symlink
   install -m755 "${PACKAGE_SRC}/catalyst.sh" "${INSTALL_ROOT}/etc/profile.d/" || return 1

   # License
   install -m644 "${PACKAGE_SOURCE_TOPDIR}/ATI_LICENSE.TXT" "${INSTALL_ROOT}/usr/local/share/doc/ati-fglrx/" || return 1
   install -m644 "${PACKAGE_SOURCE_TOPDIR}/ATI_LICENSE.TXT" "${INSTALL_ROOT}/usr/local/share/doc/ati-fglrx-kernel-source/" || return 1

   # kernel module installer
   install -m755 "${PACKAGE_SRC}/ati-fglrx-kernel-module-installer.sh" "${INSTALL_ROOT}/usr/local/sbin/ati-fglrx-kernel-module-installer"

   # kernel source
   cd "${PACKAGE_SOURCE_TOPDIR}/common/lib/modules/fglrx/build_mod"
   cp "${PACKAGE_SOURCE_TOPDIR}/arch/x86/lib/modules/fglrx/build_mod/libfglrx_ip.a.GCC4" libfglrx_ip.a.GCC4.x86 || return 1
   cp "${PACKAGE_SOURCE_TOPDIR}/arch/x86_64/lib/modules/fglrx/build_mod/libfglrx_ip.a.GCC4" libfglrx_ip.a.GCC4.x86_64 || return 1
   cp 2.6.x/Makefile . || return 1

   cd "${PACKAGE_SOURCE_TOPDIR}/common/lib/modules"

   tar -cJvf "${INSTALL_ROOT}/usr/local/src/fglrx-kernel-source.tar.xz" fglrx || return 1

}

# Rules
build_rules() {

   buildit load || exit 1
   buildit download || exit 1
   buildit unpack || exit 1
   buildit patch || exit 1
   buildit install || exit 1
   buildit split || exit 1
   buildit create || exit 1
   buildit generate || exit 1
   buildit check || exit 1
   buildit package || exit 1
   buildit compress || exit 1

}
