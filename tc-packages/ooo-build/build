#
# tc-ext-tools build functions: configure, compile, install, rules
#

### Configure
build_configure() {

  sudo ln -sf /usr/local/lib/pkgconfig/mozilla-plugin.pc /usr/local/lib/pkgconfig/xulrunner-plugin.pc

  aclocal || return 1
  autoconf --force || return 1

  ./configure --prefix=/usr/local --with-distro=TinyCore \
              --with-binsuffix="" \
              --disable-odk --enable-extensions --disable-mono --enable-graphite \
              --enable-cairo --disable-kde --disable-kde4 --disable-pam \
              --with-gcc-speedup=ccache --without-java --with-lang="" \
              --with-openclipart=/usr/local/share/openclipart \
              --with-languagetool --with-oooblogger --with-nlpsolver \
              --with-google-docs --with-watch-window --with-ct2n \
              --with-sun-templates --with-installed-ooo-dirname=openoffice3 \
              --disable-post-install-scripts \
              --with-num-cpus=2 --with-drink=coffee || return 1

}
##

### Compile
build_compile() {

  [ -e /usr/bin/python ] || sudo ln -sf /usr/local/bin/python /usr/bin/python

  if [ -d "$TCEXTTOOLS_SRC"/download-src ]; then
       busybox cp -rf "$TCEXTTOOLS_SRC"/download-src/* src/
       ./download || return 1
  else
       ./download || return 1
       mkdir -p "$TCEXTTOOLS_SRC"/download-src || return 1

       busybox cp -f src/*.gz "$TCEXTTOOLS_SRC"/download-src || return 1
       busybox cp -f src/*.bz2 "$TCEXTTOOLS_SRC"/download-src || return 1
       busybox cp -f src/*.oxt "$TCEXTTOOLS_SRC"/download-src || return 1
       busybox cp -rf src/clone "$TCEXTTOOLS_SRC"/download-src || return 1
  fi

  make || return 1

}
##

### Install
build_install() {

  sudo ./bin/ooinstall "${INSTALL_ROOT}"/usr/local/openoffice3 || return 1

  sudo ln -snf /usr/local/openoffice3/basis3.2 "${INSTALL_ROOT}"/usr/local/openoffice3/basis-link || return 1
  sudo ln -snf /usr/local/openoffice3/ure "${INSTALL_ROOT}"/usr/local/openoffice3/basis3.2/ure-link || return 1

  sudo install -m 755 -d "$INSTALL_ROOT"/usr/local/bin
  for wrapper in oobase  oocalc  oodraw  ooffice  ooimpress  oomath  ooweb  oowriter unopkg
  do
      sudo install -m 755 "$PACKAGE_SRC"/"$wrapper" "$INSTALL_ROOT"/usr/local/bin/"${wrapper}" || return 1
  done

  sudo install -m 755 -d "$INSTALL_ROOT"/usr/local/share/applications
  sudo install -m 644 desktop/*.desktop "$INSTALL_ROOT"/usr/local/share/applications || return 1
  sudo mv -f "$INSTALL_ROOT"/usr/local/share/applications/startcenter.desktop "$INSTALL_ROOT"/usr/local/share/applications/openoffice3.desktop
  sudo rm -f "$INSTALL_ROOT"/usr/local/share/applications/template.desktop

  for dir in 16x16 22x22 24x24 32x32 48x48
  do
      sudo install -m 755 -d "$INSTALL_ROOT"/usr/local/share/icons/hicolor/"$dir"/apps
      sudo install -m 755 -d "$INSTALL_ROOT"/usr/local/share/icons/hicolor/"$dir"/mimetypes
      sudo install -m 644 desktop/"$dir"/*.png "$INSTALL_ROOT"/usr/local/share/icons/hicolor/"$dir"/apps || return 1
      sudo install -m 644 desktop/mimetypes/"$dir"/*.png "$INSTALL_ROOT"/usr/local/share/icons/hicolor/"$dir"/mimetypes || return 1
  done

  sudo install -m 755 -d "$INSTALL_ROOT"/usr/local/share/icons/hicolor/scalable/apps
  sudo install -m 644 desktop/scalable/*.svg "$INSTALL_ROOT"/usr/local/share/icons/hicolor/scalable/apps || return 1

}
##

### Rules
build_rules() {

  buildit download || exit 1
  buildit convert || exit 1
  buildit unpack || exit 1
  buildit patch || exit 1
  buildit load || exit 1
  buildit configure || exit 1
  buildit compile || exit 1
  buildit install || exit 1
  buildit strip || exit 1
  buildit split || exit 1
  buildit create || exit 1
  buildit generate || exit 1
  buildit check || exit 1
  buildit package || exit 1
  buildit compress || exit 1
  buildit encrypt || exit 1

}
##
